{% extends "base.html" %}

{% block title %}‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö - ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ö‡∏≠‡∏ó Discord{% endblock %}

{% block head %}
<style>
    .setting-card {
        margin-bottom: 20px;
    }
    .card-header .btn-refresh {
        padding: 0.25rem 0.5rem;
        font-size: 0.8rem;
    }
    .invalid-feedback {
        display: none;
    }
    .is-invalid ~ .invalid-feedback {
        display: block;
    }
    .option-container {
        border: 1px solid #ddd;
        padding: 15px;
        border-radius: 5px;
        margin-bottom: 10px;
    }
    .input-group .identifier-input {
        border-right: none;
    }
    .input-group .toggle-visibility {
        background: #f8f9fa;
        border: 1px solid #ced4da;
        border-left: none;
        cursor: pointer;
        padding: 0.375rem 0.75rem;
        display: flex;
        align-items: center;
    }
    .input-group .toggle-visibility:hover {
        background: #e9ecef;
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h2><i class="fas fa-comment-dots"></i> ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö</h2>
    <div>
        <button id="add-message-btn" class="btn btn-primary me-2">
            <i class="fas fa-plus"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö
        </button>
        <button id="save-all-settings" class="btn btn-success">
            <i class="fas fa-save"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤
        </button>
    </div>
</div>

<form id="settings-form" method="POST" action="/settings/welcome_messages">
    <div class="row">
        <div class="card setting-card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-comment-dots"></i> ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö</h5>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ä‡πà‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏ô‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
                </div>
                <div id="message-settings-container">
                    {% for category_id, data in config.welcome_messages.items() %}
                    <div class="message-settings mb-4" data-category-id="{{ category_id }}">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="fw-bold">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà ID: {{ category_id }} ({{ config.categories[category_id] or '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏ä‡∏∑‡πà‡∏≠' }})</h6>
                            <button type="button" class="btn btn-sm btn-danger delete-message-btn">
                                <i class="fas fa-trash"></i> ‡∏•‡∏ö
                            </button>
                        </div>
                        <div class="mb-3">
                            <label>‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà:</label>
                            <select name="{{ category_id }}_category_id" class="form-select category-select" disabled>
                                <option value="{{ category_id }}">{{ config.categories[category_id] or category_id }}</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label>‡∏£‡∏´‡∏±‡∏™‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö PromptPay (13 ‡∏´‡∏•‡∏±‡∏Å):</label>
                            <div class="input-group">
                                <input type="password" name="{{ category_id }}_identifier" class="form-control identifier-input" value="{{ data.identifier }}" pattern="^\d{1}-\d{4}-\d{5}-\d{2}-\d{1}$" required>
                                <span class="toggle-visibility" title="‡πÅ‡∏™‡∏î‡∏á/‡∏ã‡πà‡∏≠‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô"><i class="fas fa-eye"></i></span>
                            </div>
                            <small class="form-text text-muted">‡πÄ‡∏ä‡πà‡∏ô 1-2345-67890-12-3</small>
                            <div class="invalid-feedback">‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏´‡∏±‡∏™‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö x-xxxx-xxxxx-xx-x</div>
                        </div>
                        <div class="mb-3">
                            <label>‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö:</label>
                            <textarea name="{{ category_id }}_message" class="form-control message-input" rows="3">{{ data.message }}</textarea>
                        </div>
                        <div class="mb-3">
                            <label>‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô:</label>
                            <div class="options-list">
                                {% for option in data.options %}
                                <div class="option-container">
                                    <div class="row">
                                        <div class="col-md-8">
                                            <label>‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å:</label>
                                            <input type="text" name="{{ category_id }}_option_text_{{ loop.index0 }}" class="form-control option-text-input" value="{{ option.text }}" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ü‡∏≤‡∏£‡πå‡∏° 1 ‡∏ß‡∏±‡∏ô (15 ‡∏ö‡∏≤‡∏ó)">
                                        </div>
                                        <div class="col-md-3">
                                            <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó):</label>
                                            <input type="number" name="{{ category_id }}_option_amount_{{ loop.index0 }}" class="form-control option-amount-input" value="{{ option.amount }}" step="0.01" min="0">
                                        </div>
                                        <div class="col-md-1 d-flex align-items-end">
                                            <button type="button" class="btn btn-sm btn-danger remove-option-btn">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            <button type="button" class="btn btn-sm btn-outline-primary add-option-btn mt-2">
                                <i class="fas fa-plus"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
                            </button>
                        </div>
                        <hr>
                    </div>
                    {% endfor %}
                </div>
                <div id="new-message-template" class="d-none">
                    <div class="message-settings mb-4" data-category-id="NEW_MESSAGE">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="fw-bold">‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡πÉ‡∏´‡∏°‡πà</h6>
                            <button type="button" class="btn btn-sm btn-danger delete-message-btn">
                                <i class="fas fa-trash"></i> ‡∏•‡∏ö
                            </button>
                        </div>
                        <div class="mb-3">
                            <label>‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà:</label>
                            <select class="form-select category-select" required>
                                <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà --</option>
                                {% for id, name in config.categories.items() %}
                                <option value="{{ id }}">{{ name }}</option>
                                {% endfor %}
                            </select>
                            <div class="invalid-feedback">‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</div>
                        </div>
                        <div class="mb-3">
                            <label>‡∏£‡∏´‡∏±‡∏™‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö PromptPay (13 ‡∏´‡∏•‡∏±‡∏Å):</label>
                            <div class="input-group">
                                <input type="password" class="form-control identifier-input" pattern="^\d{1}-\d{4}-\d{5}-\d{2}-\d{1}$" placeholder="‡πÄ‡∏ä‡πà‡∏ô 1-2345-67890-12-3" required>
                                <span class="toggle-visibility" title="‡πÅ‡∏™‡∏î‡∏á/‡∏ã‡πà‡∏≠‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô"><i class="fas fa-eye"></i></span>
                            </div>
                            <small class="form-text text-muted">‡πÄ‡∏ä‡πà‡∏ô 1-2345-67890-12-3</small>
                            <div class="invalid-feedback">‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏´‡∏±‡∏™‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö x-xxxx-xxxxx-xx-x</div>
                        </div>
                        <div class="mb-3">
                            <label>‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö:</label>
                            <textarea class="form-control message-input" rows="3" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏à‡πâ‡∏≤! üéâ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏û‡πá‡∏Å‡πÄ‡∏Å‡∏à‡∏ü‡∏≤‡∏£‡πå‡∏°‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏¢‡∏ô‡πâ‡∏≤" required></textarea>
                            <div class="invalid-feedback">‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏∞‡∏ö‡∏∏‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö</div>
                        </div>
                        <div class="mb-3">
                            <label>‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô:</label>
                            <div class="options-list">
                                <div class="option-container">
                                    <div class="row">
                                        <div class="col-md-8">
                                            <label>‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å:</label>
                                            <input type="text" class="form-control option-text-input" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ü‡∏≤‡∏£‡πå‡∏° 1 ‡∏ß‡∏±‡∏ô (15 ‡∏ö‡∏≤‡∏ó)" required>
                                            <div class="invalid-feedback">‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏∞‡∏ö‡∏∏‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</div>
                                        </div>
                                        <div class="col-md-3">
                                            <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó):</label>
                                            <input type="number" class="form-control option-amount-input" step="0.01" min="0" placeholder="‡πÄ‡∏ä‡πà‡∏ô 15" required>
                                            <div class="invalid-feedback">‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</div>
                                        </div>
                                        <div class="col-md-1 d-flex align-items-end">
                                            <button type="button" class="btn btn-sm btn-danger remove-option-btn">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <button type="button" class="btn btn-sm btn-outline-primary add-option-btn mt-2">
                                <i class="fas fa-plus"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
                            </button>
                        </div>
                        <hr>
                    </div>
                </div>
                <div id="no-messages-message" class="alert alert-warning text-center" style="display: {% if config.welcome_messages|length > 0 %}none{% else %}block{% endif %};">
                    <i class="fas fa-exclamation-circle"></i> ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö ‡∏Ñ‡∏•‡∏¥‡∏Å "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
                </div>
            </div>
        </div>
        <div class="d-grid gap-2 col-md-6 mx-auto my-4">
            <button type="submit" class="btn btn-lg btn-success">
                <i class="fas fa-save"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤
            </button>
        </div>
    </form>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    setupMessageEvents();

    $('#add-message-btn').on('click', function(e) {
        e.preventDefault();
        const newMessagesNotSaved = $('#message-settings-container > .message-settings[data-category-id="NEW_MESSAGE"]').length;
        if (newMessagesNotSaved > 0) {
            alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà');
            $('#message-settings-container > .message-settings[data-category-id="NEW_MESSAGE"]').first().find('.category-select').focus();
            return;
        }
        const template = $('#new-message-template').html();
        $('#message-settings-container').append(template);
        $('#no-messages-message').hide();
        const newMessage = $('#message-settings-container > .message-settings').last();
        $('html, body').animate({
            scrollTop: newMessage.offset().top - 100
        }, 500);
        newMessage.find('.category-select').focus();
        setupMessageEvents();
    });

    $('#settings-form').submit(function(e) {
        e.preventDefault();
        const messages = collectMessages();
        if (Object.keys(messages).length === 0) {
            alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å');
            return;
        }
        const submitBtn = $(this).find('button[type="submit"]');
        const originalBtnText = submitBtn.html();
        submitBtn.html('<i class="fas fa-spinner fa-spin"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...');
        submitBtn.prop('disabled', true);
        $.ajax({
            url: '/settings/welcome_messages',
            type: 'POST',
            data: { welcome_messages: JSON.stringify(messages) },
            success: function(response) {
                alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
                location.reload();
            },
            error: function(xhr) {
                console.error('Error saving welcome messages:', xhr);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å: ' + (xhr.responseJSON?.message || xhr.responseText || '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏'));
                submitBtn.html(originalBtnText);
                submitBtn.prop('disabled', false);
            }
        });
    });

    function setupMessageEvents() {
        $('.delete-message-btn').off('click').on('click', function() {
            if (confirm('‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏ô‡∏µ‡πâ?')) {
                $(this).closest('.message-settings').remove();
                if ($('#message-settings-container').children('.message-settings').length === 0) {
                    $('#no-messages-message').show();
                }
            }
        });

        $('.add-option-btn').off('click').on('click', function() {
            const optionsList = $(this).siblings('.options-list');
            const optionCount = optionsList.find('.option-container').length;
            const newOption = $(`
                <div class="option-container">
                    <div class="row">
                        <div class="col-md-8">
                            <label>‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å:</label>
                            <input type="text" class="form-control option-text-input" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ü‡∏≤‡∏£‡πå‡∏° 1 ‡∏ß‡∏±‡∏ô (15 ‡∏ö‡∏≤‡∏ó)" required>
                            <div class="invalid-feedback">‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏∞‡∏ö‡∏∏‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</div>
                        </div>
                        <div class="col-md-3">
                            <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó):</label>
                            <input type="number" class="form-control option-amount-input" step="0.01" min="0" placeholder="‡πÄ‡∏ä‡πà‡∏ô 15" required>
                            <div class="invalid-feedback">‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</div>
                        </div>
                        <div class="col-md-1 d-flex align-items-end">
                            <button type="button" class="btn btn-sm btn-danger remove-option-btn">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `);
            optionsList.append(newOption);
            setupOptionEvents();
        });

        $('.remove-option-btn').off('click').on('click', function() {
            const optionContainer = $(this).closest('.option-container');
            if ($(this).closest('.options-list').find('.option-container').length > 1) {
                optionContainer.remove();
            } else {
                alert('‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô');
            }
        });

        $('.category-select').off('change').on('change', function() {
            const messageSettings = $(this).closest('.message-settings');
            const categoryId = $(this).val();
            if (categoryId) {
                const isDuplicate = $('.message-settings').not(messageSettings).filter(`[data-category-id="${categoryId}"]`).length > 0;
                if (isDuplicate) {
                    $(this).addClass('is-invalid');
                    $(this).siblings('.invalid-feedback').text('‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß');
                    return;
                }
                messageSettings.attr('data-category-id', categoryId);
                $(this).removeClass('is-invalid');
                $(this).siblings('.invalid-feedback').text('‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà');
            }
        });

        $('.identifier-input').off('input').on('input', function() {
            $(this).removeClass('is-invalid');
            const value = $(this).val();
            if (value && !/^\d{1}-\d{4}-\d{5}-\d{2}-\d{1}$/.test(value)) {
                $(this).addClass('is-invalid');
                $(this).siblings('.invalid-feedback').text('‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏´‡∏±‡∏™‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö x-xxxx-xxxxx-xx-x');
            }
        });

        $('.toggle-visibility').off('click').on('click', function() {
            const input = $(this).siblings('.identifier-input');
            const icon = $(this).find('i');
            if (input.attr('type') === 'password') {
                input.attr('type', 'text');
                icon.removeClass('fa-eye').addClass('fa-eye-slash');
            } else {
                input.attr('type', 'password');
                icon.removeClass('fa-eye-slash').addClass('fa-eye');
            }
        });

        $('.message-input, .option-text-input, .option-amount-input').off('input').on('input', function() {
            $(this).removeClass('is-invalid');
            const value = $(this).val();
            if ($(this).hasClass('option-amount-input') && (isNaN(value) || value <= 0)) {
                $(this).addClass('is-invalid');
                $(this).siblings('.invalid-feedback').text('‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 0');
            }
            if ($(this).hasClass('option-text-input') && !value.trim()) {
                $(this).addClass('is-invalid');
                $(this).siblings('.invalid-feedback').text('‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏∞‡∏ö‡∏∏‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å');
            }
            if ($(this).hasClass('message-input') && !value.trim()) {
                $(this).addClass('is-invalid');
                $(this).siblings('.invalid-feedback').text('‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏∞‡∏ö‡∏∏‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö');
            }
        });
    }

    function setupOptionEvents() {
        $('.remove-option-btn').off('click').on('click', function() {
            const optionContainer = $(this).closest('.option-container');
            if ($(this).closest('.options-list').find('.option-container').length > 1) {
                optionContainer.remove();
            } else {
                alert('‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô');
            }
        });

        $('.option-text-input').off('input').on('input', function() {
            $(this).removeClass('is-invalid');
            const value = $(this).val();
            if (!value.trim()) {
                $(this).addClass('is-invalid');
                $(this).siblings('.invalid-feedback').text('‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏∞‡∏ö‡∏∏‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å');
            }
        });

        $('.option-amount-input').off('input').on('input', function() {
            $(this).removeClass('is-invalid');
            const value = parseFloat($(this).val());
            if (isNaN(value) || value <= 0) {
                $(this).addClass('is-invalid');
                $(this).siblings('.invalid-feedback').text('‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 0');
            }
        });
    }

    function collectMessages() {
        const messages = {};
        $('.message-settings').each(function() {
            const categoryId = $(this).attr('data-category-id');
            if (categoryId === 'NEW_MESSAGE') {
                return;
            }
            const message = $(this).find('.message-input').length > 0
                ? $(this).find('.message-input').val().trim()
                : $(`textarea[name="${categoryId}_message"]`).val().trim();
            const identifier = $(this).find('.identifier-input').length > 0
                ? $(this).find('.identifier-input').val().trim()
                : $(`input[name="${categoryId}_identifier"]`).val().trim();
            const options = [];
            $(this).find('.option-container').each(function(index) {
                const text = $(this).find('.option-text-input').length > 0
                    ? $(this).find('.option-text-input').val().trim()
                    : $(`input[name="${categoryId}_option_text_${index}"]`).val().trim();
                const amount = $(this).find('.option-amount-input').length > 0
                    ? parseFloat($(this).find('.option-amount-input').val())
                    : parseFloat($(`input[name="${categoryId}_option_amount_${index}"]`).val());
                if (text && !isNaN(amount) && amount > 0) {
                    options.push({ text, amount });
                }
            });
            if (categoryId && message && identifier && /^\d{1}-\d{4}-\d{5}-\d{2}-\d{1}$/.test(identifier) && options.length > 0) {
                messages[categoryId] = {
                    message,
                    identifier,
                    options
                };
            } else {
                console.log(`‡∏Ç‡πâ‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤: ${categoryId} (‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô)`);
                if (!categoryId) {
                    alert(`‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà ID ${categoryId} ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö`);
                } else if (!message) {
                    alert(`‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà ID ${categoryId}`);
                } else if (!/^\d{1}-\d{4}-\d{5}-\d{2}-\d{1}$/.test(identifier)) {
                    alert(`‡∏£‡∏´‡∏±‡∏™‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà ID ${categoryId} ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö x-xxxx-xxxxx-xx-x (‡πÄ‡∏ä‡πà‡∏ô 1-2345-67890-12-3)`);
                } else if (options.length === 0) {
                    alert(`‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà ID ${categoryId}`);
                }
            }
        });
        return messages;
    }

    $('#save-all-settings').click(function(e) {
        e.preventDefault();
        $('#settings-form').submit();
    });

    let originalFormData = $('#settings-form').serialize();
    $('#settings-form :input').on('change input', function() {
        if ($('#settings-form').serialize() !== originalFormData) {
            window.onbeforeunload = () => "‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ?";
        } else {
            window.onbeforeunload = null;
        }
    });
    $('#settings-form').submit(() => window.onbeforeunload = null);
});
</script>
{% endblock %}