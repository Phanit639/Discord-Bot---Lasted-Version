{% extends "base.html" %}

{% block title %}‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡πà‡∏≠‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ - ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ö‡∏≠‡∏ó Discord{% endblock %}

{% block head %}
<style>
    .setting-card {
        margin-bottom: 20px;
    }
    .card-header .btn-refresh {
        padding: 0.25rem 0.5rem;
        font-size: 0.8rem;
    }
    .category-select, .name-format-select {
        width: 100%;
    }
    .invalid-feedback {
        display: none;
    }
    .is-invalid ~ .invalid-feedback {
        display: block;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2><i class="fas fa-edit"></i> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡πà‡∏≠‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</h2>
        <div>
            <button id="add-setting-btn" class="btn btn-primary me-2">
                <i class="fas fa-plus"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤
            </button>
            <button id="save-settings-btn" class="btn btn-success">
                <i class="fas fa-save"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤
            </button>
        </div>
    </div>

    <form id="settings-form" method="POST" action="/settings/channel_names">
        <div class="card setting-card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-edit"></i> ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡πà‡∏≠‡∏á</h5>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡πà‡∏≠‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ä‡πà‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏ô‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
                    <br><strong>‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á:</strong>
                    <ul>
                        <li><strong>‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏ï‡πá‡∏°:</strong> ‡∏ä‡πà‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏° ‚Üí ‡πÅ‡∏£‡∏Å‡∏ô‡πà‡∏≤-‡πÉ‡∏´‡∏°‡πà</li>
                        <li><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤:</strong> 13-04-‡∏à‡∏ö‡∏á‡∏≤‡∏ô</li>
                        <li><strong>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏ä‡πà‡∏≠‡∏á + ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</strong> üé´1234-13-04-‡πÇ‡∏Å‡∏à‡∏¥‡∏ï‡πâ‡∏≤</li>
                    </ul>
                </div>
                <div id="name-settings-container">
                    {% for name, data in config.channel_name_mappings.items() %}
                    <div class="name-setting mb-4" data-setting-id="{{ name }}">
                        <div class="d-flex justify-content-between align-items-center mb-2 setting-name-container">
                            <div class="input-group" style="max-width: 50%;">
                                <span class="input-group-text">‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</span>
                                <input type="text" name="name_{{ name }}" class="form-control setting-name-input" value="{{ name }}" disabled>
                            </div>
                            <div>
                                <button type="button" class="btn btn-sm btn-outline-primary edit-setting-name-btn ms-2">
                                    <i class="fas fa-edit"></i> ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ä‡∏∑‡πà‡∏≠
                                </button>
                                <button type="button" class="btn btn-sm btn-danger delete-setting-btn">
                                    <i class="fas fa-trash"></i> ‡∏•‡∏ö
                                </button>
                            </div>
                        </div>
                        <div class="setting-details">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label>‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏´‡∏•‡∏±‡∏Å:</label>
                                    <select name="{{ name }}_category_id_1" class="form-select category-select">
                                        <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà --</option>
                                        {% for id, category_name in config.categories.items() %}
                                        <option value="{{ id }}" {% if id == data.category_id %}selected{% endif %}>{{ category_name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label>‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ä‡∏∑‡πà‡∏≠:</label>
                                    <select name="{{ name }}_name_format" class="form-select name-format-select">
                                        <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö --</option>
                                        <option value="full_name" {% if data.name_format == 'full_name' %}selected{% endif %}>‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏ï‡πá‡∏°</option>
                                        <option value="date_prefix" {% if data.name_format == 'date_prefix' %}selected{% endif %}>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤ (‡∏ß‡∏±‡∏ô-‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)</option>
                                        <option value="ticket_date_prefix" {% if data.name_format == 'ticket_date_prefix' %}selected{% endif %}>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏ä‡πà‡∏≠‡∏á + ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</option>
                                    </select>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label>‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡πà‡∏≠‡∏á:</label>
                                <input type="text" name="{{ name }}_custom_text" class="form-control custom-text-input" value="{{ data.custom_text }}" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÅ‡∏£‡∏Å‡∏ô‡πà‡∏≤-‡πÉ‡∏´‡∏°‡πà">
                            </div>
                            <hr>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                <div id="no-settings-message" class="alert alert-warning text-center" style="display: {% if config.channel_name_mappings|length > 0 %}none{% else %}block{% endif %};">
                    <i class="fas fa-exclamation-circle"></i> ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÉ‡∏î‡πÜ ‡∏Ñ‡∏•‡∏¥‡∏Å "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
                </div>
                <div id="new-setting-template" class="d-none">
                    <div class="name-setting mb-4" data-setting-id="NEW_SETTING">
                        <div class="d-flex justify-content-between align-items-center mb-2 setting-name-container">
                            <div class="input-group" style="max-width: 50%;">
                                <span class="input-group-text">‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</span>
                                <input type="text" class="form-control setting-name-input" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏£‡∏Å‡∏ô‡πà‡∏≤">
                            </div>
                            <div>
                                <button type="button" class="btn btn-sm btn-success save-setting-name-btn">
                                    <i class="fas fa-check"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ä‡∏∑‡πà‡∏≠
                                </button>
                                <button type="button" class="btn btn-sm btn-danger delete-setting-btn">
                                    <i class="fas fa-trash"></i> ‡∏•‡∏ö
                                </button>
                            </div>
                        </div>
                        <div class="setting-details" style="display: none;">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label>‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏´‡∏•‡∏±‡∏Å:</label>
                                    <select class="form-select category-select">
                                        <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà --</option>
                                        {% for id, name in config.categories.items() %}
                                        <option value="{{ id }}">{{ name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label>‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ä‡∏∑‡πà‡∏≠:</label>
                                    <select class="form-select name-format-select">
                                        <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö --</option>
                                        <option value="full_name">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏ï‡πá‡∏°</option>
                                        <option value="date_prefix">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤ (‡∏ß‡∏±‡∏ô-‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)</option>
                                        <option value="ticket_date_prefix">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏ä‡πà‡∏≠‡∏á + ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</option>
                                    </select>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label>‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡πà‡∏≠‡∏á:</label>
                                <input type="text" class="form-control custom-text-input" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÅ‡∏£‡∏Å‡∏ô‡πà‡∏≤-‡πÉ‡∏´‡∏°‡πà">
                            </div>
                            <hr>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="d-grid gap-2 col-md-6 mx-auto my-4">
            <button type="submit" class="btn btn-lg btn-success">
                <i class="fas fa-save"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤
            </button>
        </div>
    </form>
</div>

{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà
    let categories = {{ config.categories | tojson }};
    let channelNameMappings = {{ config.channel_name_mappings | tojson | default({}) }};

    // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤
    const $settingsContainer = $('#name-settings-container');
    if (Object.keys(channelNameMappings).length === 0) {
        $('#no-settings-message').show();
    }

    // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÉ‡∏´‡∏°‡πà
    $('#add-setting-btn').on('click', function(e) {
        e.preventDefault();
        const newSettingsNotSaved = $settingsContainer.find('.name-setting[data-setting-id="NEW_SETTING"]').length;
        if (newSettingsNotSaved > 0) {
            alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÉ‡∏´‡∏°‡πà');
            $settingsContainer.find('.name-setting[data-setting-id="NEW_SETTING"]').first().find('.setting-name-input').focus();
            return;
        }

        const template = $('#new-setting-template').html();
        $settingsContainer.append(template);
        $('#no-settings-message').hide();

        const $newSetting = $settingsContainer.children().last();
        $('html, body').animate({
            scrollTop: $newSetting.offset().top - 100
        }, 500);

        $newSetting.find('.setting-name-input').focus();
        setupSettingEvents();
    });

    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤
    $('#settings-form').submit(function(e) {
        e.preventDefault();
        const mappings = collectSettings();
        if (mappings.length === 0) {
            alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');
            return;
        }

        console.log("‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏™‡πà‡∏á:", mappings);

        const submitBtn = $(this).find('button[type="submit"]');
        const originalBtnText = submitBtn.html();
        submitBtn.html('<i class="fas fa-spinner fa-spin"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...');
        submitBtn.prop('disabled', true);

        $.ajax({
            url: '/settings/channel_names',
            type: 'POST',
            data: { channel_name_mappings: JSON.stringify(mappings) },
            success: function(response) {
                alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
                location.reload();
            },
            error: function(xhr) {
                console.error('Error saving channel name mappings:', xhr);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å: ' + (xhr.responseText || '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏'));
                submitBtn.html(originalBtnText);
                submitBtn.prop('disabled', false);
            }
        });
    });

    $('#save-settings-btn').click(function(e) {
        e.preventDefault();
        $('#settings-form').submit();
    });

    // ‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
    let originalFormData = $('#settings-form').serialize();
    $('#settings-form :input').on('change input', function() {
        if ($('#settings-form').serialize() !== originalFormData) {
            window.onbeforeunload = () => "‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ?";
        } else {
            window.onbeforeunload = null;
        }
    });
    $('#settings-form').submit(() => window.onbeforeunload = null);

    function setupSettingEvents() {
        $('.delete-setting-btn').off('click').on('click', function() {
            if (confirm('‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ô‡∏µ‡πâ?')) {
                $(this).closest('.name-setting').remove();
                if ($settingsContainer.children('.name-setting').length === 0) {
                    $('#no-settings-message').show();
                }
            }
        });

        $('.save-setting-name-btn').off('click').on('click', function() {
            const $setting = $(this).closest('.name-setting');
            const $nameInput = $setting.find('.setting-name-input');
            const name = $nameInput.val().trim();

            if (!name) {
                $nameInput.addClass('is-invalid');
                if ($setting.find('.invalid-feedback').length === 0) {
                    $nameInput.after('<div class="invalid-feedback">‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</div>');
                }
                return;
            }

            let isDuplicate = false;
            $settingsContainer.find('.name-setting').not($setting).each(function() {
                const existingName = $(this).find('.setting-name-input').val().trim();
                if (existingName === name) {
                    isDuplicate = true;
                    return false;
                }
            });

            if (isDuplicate) {
                $nameInput.addClass('is-invalid');
                if ($setting.find('.invalid-feedback').length === 0) {
                    $nameInput.after('<div class="invalid-feedback">‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß</div>');
                } else {
                    $setting.find('.invalid-feedback').text('‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß');
                }
                return;
            }

            $setting.attr('data-setting-id', name);
            $nameInput.prop('disabled', true);
            $nameInput.removeClass('is-invalid');
            $setting.find('.invalid-feedback').remove();
            $(this).hide();
            $setting.find('.setting-details').slideDown(300);

            const $editBtn = $('<button type="button" class="btn btn-sm btn-outline-primary edit-setting-name-btn ms-2"><i class="fas fa-edit"></i> ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ä‡∏∑‡πà‡∏≠</button>');
            $(this).after($editBtn);
            $editBtn.on('click', function() {
                $nameInput.prop('disabled', false);
                $nameInput.focus();
                $(this).hide();
                $setting.find('.save-setting-name-btn').show();
            });
        });

        $('.setting-name-input').off('input').on('input', function() {
            $(this).removeClass('is-invalid');
            $(this).next('.invalid-feedback').remove();
        });
    }

    function collectSettings() {
        const mappings = [];
        $settingsContainer.find('.name-setting').each(function() {
            const settingId = $(this).attr('data-setting-id');
            if (settingId === 'NEW_SETTING') {
                return;
            }
            let mapping = {};
            if ($(this).find('.setting-name-input').length > 0) {
                mapping = {
                    name: $(this).find('.setting-name-input').val()?.trim() || "",
                    category_id: $(this).find('.category-select').val() || "",
                    name_format: $(this).find('.name-format-select').val() || "full_name",
                    custom_text: $(this).find('.custom-text-input').val()?.trim() || ""
                };
            } else {
                mapping = {
                    name: $(`input[name="name_${settingId}"]`).val()?.trim() || "",
                    category_id: $(`select[name="${settingId}_category_id_1"]`).val() || "",
                    name_format: $(`select[name="${settingId}_name_format"]`).val() || "full_name",
                    custom_text: $(`input[name="${settingId}_custom_text"]`).val()?.trim() || ""
                };
            }
            if (mapping.name && mapping.category_id && mapping.name_format && mapping.custom_text) {
                mappings.push(mapping);
            } else {
                console.log(`‡∏Ç‡πâ‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤: ${mapping.name || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠'} (‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô)`);
            }
        });
        return mappings;
    }

    setupSettingEvents();
});
</script>
{% endblock %}